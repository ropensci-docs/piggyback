<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="piggyback">
<title>Cloud native workflows with piggyback • piggyback</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Cloud native workflows with piggyback">
<meta property="og:description" content="piggyback">
<meta property="og:image" content="https://docs.ropensci.org/piggyback/logo.svg">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">piggyback</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.5.9004</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/piggyback.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/alternatives.html">Piggyback comparison to alternatives</a>
    <a class="dropdown-item" href="../articles/cloud_native.html">Cloud native workflows with piggyback</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/piggyback/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Cloud native workflows with piggyback</h1>
                        <h4 data-toc-skip class="author">Tan Ho, Carl Boettiger</h4>
            
            <h4 data-toc-skip class="date">2023-12-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/piggyback/blob/HEAD/vignettes/cloud_native.Rmd" class="external-link"><code>vignettes/cloud_native.Rmd</code></a></small>
      <div class="d-none name"><code>cloud_native.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/piggyback/">piggyback</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-too-big-to-fit-in-memory">Data Too Big To Fit In Memory<a class="anchor" aria-label="anchor" href="#data-too-big-to-fit-in-memory"></a>
</h2>
<p>One of the primary advantages of <code>piggyback</code> is the ability to store a lot of fairly large files. This is also potentially the source of some frustrations: piggyback assets may potentially be quite large (too large to fit in RAM) and difficult to work with once they have been uploaded to the release.</p>
<p>There are a substantial and rapidly growing number of packages that are able to work with data on-disk without reading the whole thing into memory, including <a href="https://rspatial.github.io/terra/" class="external-link"><code>terra</code></a>, <a href="https://r-spatial.github.io/stars/" class="external-link"><code>stars</code></a>, and <a href="https://r-spatial.github.io/sf/index.html" class="external-link"><code>sf</code></a> for large spatial assets, as well as <a href="https://arrow.apache.org/docs/r/" class="external-link"><code>arrow</code></a> and <a href="https://duckdb.org/docs/api/r.html" class="external-link"><code>duckdb</code></a> for tabular data.</p>
<p>Going a step further, such libraries now also make it possible to not only skip the ‘read twice’ pattern of downloading once to disk and reading to disk, but can let you skip ever reading the whole data file into R at all - for instance, spatial packages can use GDAL’s <a href="https://gdal.org/user/virtual_file_systems.html" class="external-link">virtual file system</a>.</p>
<p><code>arrow</code> and <code>duckdb</code> can do similar tricks on parquet and csv files, allowing users to leverage functions like <code>dplyr::select()</code> and <code>dplyr::filter()</code> directly on the remote data source to access only the subset of rows/columns they need. Subsetting data directly from a URL in this manner thus has the performance benefit of reading directly into memory while also having the added benefit of allowing more efficient and bigger-than-RAM workflows. This is sometimes referred to as <strong>cloud-native</strong> workflows.</p>
</div>
<div class="section level2">
<h2 id="nflverse-play-by-play">nflverse play by play<a class="anchor" aria-label="anchor" href="#nflverse-play-by-play"></a>
</h2>
<p>This vignette shows some examples of using <code>duckdb</code> for querying larger datasets, using example data from the <a href="https://github.com/nflverse" class="external-link"><code>nflverse</code></a> project for NFL football analytics. (Consult the nflverse’s <a href="https://nflreadr.nflverse.com" class="external-link">nflreadr</a> package if looking to work with NFL data beyond this example)</p>
<p>The <a href="https://github.com/nflverse/nflverse-data/releases" class="external-link">nflverse/nflverse-data</a> data repository is organized into one release for a specific dataframe and typically sharded into multiple files (and file formats) by season. Here’s a brief glimpse at how this looks under the piggyback lens:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pb_releases.html">pb_releases</a></span><span class="op">(</span><span class="st">"nflverse/nflverse-data"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A data.frame: 20 × 10</span></span>
<span><span class="co">#&gt;   release_name release_id release_body        tag_name draft created_at published_at</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;             &lt;int&gt; &lt;chr&gt;               &lt;chr&gt;    &lt;lgl&gt; &lt;chr&gt;      &lt;chr&gt;       </span></span>
<span><span class="co">#&gt; 1 rosters        58152863 "Roster data, acce… rosters  FALSE 2022-01-2… 2022-01-28T…</span></span>
<span><span class="co">#&gt; 2 player_stats   58152881 "Play by play data… player_… FALSE 2022-01-2… 2022-01-28T…</span></span>
<span><span class="co">#&gt; 3 pbp            58152862 "Play by play data… pbp      FALSE 2022-01-2… 2022-01-28T…</span></span>
<span><span class="co">#&gt; 4 pfr_advstats   58152981 "PFR Adv Stats dat… pfr_adv… FALSE 2022-01-2… 2022-01-28T…</span></span>
<span><span class="co">#&gt; 5 depth_charts   58152948 "Depth chart data,… depth_c… FALSE 2022-01-2… 2022-01-28T…</span></span>
<span><span class="co">#&gt; # ℹ 15 more rows</span></span>
<span><span class="co">#&gt; # ℹ 3 more variables: html_url &lt;chr&gt;, upload_url &lt;chr&gt;, n_assets &lt;int&gt;</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span></span>
<span><span class="fu"><a href="../reference/pb_list.html">pb_list</a></span><span class="op">(</span>repo <span class="op">=</span> <span class="st">"nflverse/nflverse-data"</span>, tag <span class="op">=</span> <span class="st">"pbp"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A data.frame: 148 × 6</span></span>
<span><span class="co">#&gt;    file_name                     size timestamp           tag   owner repo </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                        &lt;int&gt; &lt;dttm&gt;              &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt;  1 play_by_play_2023.rds     12308832 2023-12-26 17:10:52 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt;  2 play_by_play_2023.parquet 17469950 2023-12-26 17:11:02 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt;  3 play_by_play_2023.csv     84490319 2023-12-26 17:10:58 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt;  4 play_by_play_2022.rds     14387514 2023-02-28 09:25:26 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt;  5 play_by_play_2022.parquet 20003378 2023-02-28 09:25:35 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt;  6 play_by_play_2022.csv     97205016 2023-02-28 09:25:31 pbp   nflv… nflv…</span></span>
<span><span class="co">#&gt; # ℹ 143 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span></span>
<span><span class="fu"><a href="../reference/pb_download_url.html">pb_download_url</a></span><span class="op">(</span></span>
<span>  <span class="st">"play_by_play_2023.csv"</span>, </span>
<span>  repo <span class="op">=</span> <span class="st">"nflverse/nflverse-data"</span>, </span>
<span>  tag <span class="op">=</span> <span class="st">"pbp"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">glimpse</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 42,066</span></span>
<span><span class="co">#&gt; Columns: 372</span></span>
<span><span class="co">#&gt; $ play_id                              &lt;int&gt; 1, 39, 55, 77, 102, 124, 147…</span></span>
<span><span class="co">#&gt; $ game_id                              &lt;chr&gt; "2023_01_ARI_WAS", "2023_01_…</span></span>
<span><span class="co">#&gt; $ home_team                            &lt;chr&gt; "WAS", "WAS", "WAS", "WAS", …</span></span>
<span><span class="co">#&gt; $ away_team                            &lt;chr&gt; "ARI", "ARI", "ARI", "ARI", …</span></span>
<span><span class="co">#&gt; $ season_type                          &lt;chr&gt; "REG", "REG", "REG", "REG", …</span></span>
<span><span class="co">#&gt; $ week                                 &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…</span></span>
<span><span class="co">#&gt; $ posteam                              &lt;chr&gt; "", "WAS", "WAS", "WAS", "WA…</span></span>
<span><span class="co">#&gt; $ posteam_type                         &lt;chr&gt; "", "home", "home", "home", …</span></span>
<span><span class="co">#&gt; $ defteam                              &lt;chr&gt; "", "ARI", "ARI", "ARI", "AR…</span></span>
<span><span class="co">#&gt; $ yardline_100                         &lt;int&gt; NA, 35, 75, 72, 66, 64, 64, …</span></span>
<span><span class="co">#&gt; $ down                                 &lt;int&gt; NA, NA, 1, 2, 3, 1, 2, 1, 2,…</span></span>
<span><span class="co">#&gt; $ play_type                            &lt;chr&gt; "", "kickoff", "run", "pass"…</span></span></code></pre></div>
<p>We’ll look at the play by play release data and try to calculate some summary statistics, without downloading it or reading it all into RAM…</p>
</div>
<div class="section level2">
<h2 id="duckdb">DuckDB<a class="anchor" aria-label="anchor" href="#duckdb"></a>
</h2>
<p>Packages used in this section:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/piggyback/">piggyback</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dbi.r-dbi.org" class="external-link">DBI</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r.duckdb.org/" class="external-link">duckdb</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://glue.tidyverse.org/" class="external-link">glue</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jabiru/tictoc" class="external-link">tictoc</a></span><span class="op">)</span></span></code></pre></div>
<p>First, initialize duckdb and install/load <code>httpfs</code> (short for http file system)</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbConnect</span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu">duckdb</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbExecute</span><span class="op">(</span><span class="va">conn</span>, <span class="st">"INSTALL 'httpfs'; LOAD 'httpfs';"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we’ll need to get all of the relevant play-by-play URLs from the release - we can do this with <code>pb_download_url</code> - and pass it into duckdb’s <a href="https://duckdb.org/docs/data/multiple_files/overview" class="external-link">read_parquet function</a></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pbp_urls</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pb_download_url.html">pb_download_url</a></span><span class="op">(</span>repo <span class="op">=</span> <span class="st">"nflverse/nflverse-data"</span>, tag <span class="op">=</span> <span class="st">"pbp"</span><span class="op">)</span></span>
<span><span class="co"># keep only the ones matching the desired regex pattern, "play_by_play_####.parquet"</span></span>
<span><span class="va">pbp_urls</span> <span class="op">&lt;-</span> <span class="va">pbp_urls</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"play_by_play_\\d+.parquet"</span>, <span class="va">pbp_urls</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span><span class="st">"SELECT COUNT(*) as row_count FROM read_parquet([{pbp_urls *}])"</span>, .con <span class="op">=</span> <span class="va">conn</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span>conn <span class="op">=</span> <span class="va">conn</span>, <span class="va">query</span><span class="op">)</span></span>
<span><span class="co">#&gt;   row_count</span></span>
<span><span class="co">#&gt; 1   1190783</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 2.845 sec elapsed</span></span></code></pre></div>
<p>Now, we can construct a SQL query that summarizes the data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  SELECT</span></span>
<span><span class="st">    season,</span></span>
<span><span class="st">    posteam,</span></span>
<span><span class="st">    play_type,</span></span>
<span><span class="st">    COUNT(play_id) AS n_plays,</span></span>
<span><span class="st">    AVG(epa) AS epa_per_play</span></span>
<span><span class="st">  FROM read_parquet([{pbp_urls *}], filename = true)</span></span>
<span><span class="st">  WHERE filename SIMILAR TO '.*(2021|2022|2023).*'</span></span>
<span><span class="st">  AND (pass = 1 OR rush = 1)</span></span>
<span><span class="st">  GROUP BY season, posteam, play_type</span></span>
<span><span class="st">  ORDER BY season DESC, posteam ASC, n_plays DESC</span></span>
<span><span class="st">  "</span>,</span>
<span>  .con <span class="op">=</span> <span class="va">conn</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbGetQuery</span><span class="op">(</span>conn <span class="op">=</span> <span class="va">conn</span>, <span class="va">query</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A data.frame: 288 × 5</span></span>
<span><span class="co">#&gt;    season posteam play_type n_plays epa_per_play</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   2023 ARI     pass          539      -0.231 </span></span>
<span><span class="co">#&gt;  2   2023 ARI     run           391       0.0351</span></span>
<span><span class="co">#&gt;  3   2023 ARI     no_play        48       0.191 </span></span>
<span><span class="co">#&gt;  4   2023 ATL     pass          499      -0.0738</span></span>
<span><span class="co">#&gt;  5   2023 ATL     run           465      -0.103 </span></span>
<span><span class="co">#&gt; # ℹ 283 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 3.343 sec elapsed</span></span></code></pre></div>
<p>You can also turn this into a view and query it with dbplyr/dplyr instead:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">query</span> <span class="op">&lt;-</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue_sql.html" class="external-link">glue_sql</a></span><span class="op">(</span></span>
<span>  <span class="st">"</span></span>
<span><span class="st">  CREATE VIEW pbp AS</span></span>
<span><span class="st">  SELECT</span></span>
<span><span class="st">    *</span></span>
<span><span class="st">  FROM read_parquet([{pbp_urls *}], filename = true)</span></span>
<span><span class="st">  "</span>,</span>
<span>  .con <span class="op">=</span> <span class="va">conn</span></span>
<span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu">dbExecute</span><span class="op">(</span><span class="va">conn</span>, <span class="va">query</span><span class="op">)</span></span>
<span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">tbl</span><span class="op">(</span><span class="va">conn</span>, <span class="st">"pbp"</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pbp</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"2021|2022|2023"</span>, <span class="va">filename</span><span class="op">)</span>, <span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">summarise</span><span class="op">(</span></span>
<span>    n_plays <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    epa_per_play <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">epa</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">season</span>, <span class="va">posteam</span>, <span class="va">play_type</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">arrange</span><span class="op">(</span></span>
<span>    <span class="fu">desc</span><span class="op">(</span><span class="va">season</span><span class="op">)</span>, <span class="va">posteam</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">n_plays</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 288 × 5</span></span>
<span><span class="co">#&gt;    season posteam play_type n_plays epa_per_play</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   2023 ARI     pass          539      -0.231 </span></span>
<span><span class="co">#&gt;  2   2023 ARI     run           391       0.0351</span></span>
<span><span class="co">#&gt;  3   2023 ARI     no_play        48       0.191 </span></span>
<span><span class="co">#&gt;  4   2023 ATL     pass          499      -0.0738</span></span>
<span><span class="co">#&gt;  5   2023 ATL     run           465      -0.103 </span></span>
<span><span class="co">#&gt; # ℹ 283 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 3.491 sec elapsed</span></span></code></pre></div>
<p>Using duckdb certainly adds a little verbosity - in exchange, we’ve managed to query and summarize the 20+ parquet files summing 1M+ rows without having to load it all into memory!</p>
<div class="section level3">
<h3 id="duckdbfs">duckdbfs<a class="anchor" aria-label="anchor" href="#duckdbfs"></a>
</h3>
<p><a href="https://cran.r-project.org/package=duckdbfs" class="external-link">duckdbfs</a> was developed to wrap this latter workflow into a single function call that accepts a vector of URLs:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cboettig/duckdbfs" class="external-link">duckdbfs</a></span><span class="op">)</span></span>
<span><span class="va">pbp</span> <span class="op">&lt;-</span> <span class="fu">duckdbfs</span><span class="fu">::</span><span class="fu">open_dataset</span><span class="op">(</span><span class="va">pbp_urls</span>, filename <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">tic</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pbp</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"2021|2022|2023"</span>, <span class="va">filename</span><span class="op">)</span>, <span class="va">pass</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">rush</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">summarise</span><span class="op">(</span></span>
<span>    n_plays <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">n</span><span class="op">(</span><span class="op">)</span>,</span>
<span>    epa_per_play <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">epa</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">season</span>, <span class="va">posteam</span>, <span class="va">play_type</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">arrange</span><span class="op">(</span></span>
<span>    <span class="fu">desc</span><span class="op">(</span><span class="va">season</span><span class="op">)</span>, <span class="va">posteam</span>, <span class="fu">desc</span><span class="op">(</span><span class="va">n_plays</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">collect</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 288 × 5</span></span>
<span><span class="co">#&gt;    season posteam play_type n_plays epa_per_play</span></span>
<span><span class="co">#&gt;     &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt;        &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1   2023 ARI     pass          539      -0.231 </span></span>
<span><span class="co">#&gt;  2   2023 ARI     run           391       0.0351</span></span>
<span><span class="co">#&gt;  3   2023 ARI     no_play        48       0.191 </span></span>
<span><span class="co">#&gt;  4   2023 ATL     pass          499      -0.0738</span></span>
<span><span class="co">#&gt;  5   2023 ATL     run           465      -0.103 </span></span>
<span><span class="co">#&gt; # ℹ 283 more rows</span></span>
<span><span class="co">#&gt; # ℹ Use `print(n = ...)` to see more rows</span></span>
<span><span class="fu">tictoc</span><span class="fu">::</span><span class="fu">toc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; 3.492 sec elapsed</span></span></code></pre></div>
<!--
## Arrow

Note: Arrow doesn't yet support [HTTP querying](https://github.com/apache/arrow/issues/18980),
although hopefully it will soon - if/when it does we'll update this vignette!


```r
library(piggyback)
library(arrow)
library(dplyr)
library(nflreadr)
```

Arrow is very efficient at running on-disk (i.e. outside of memory) queries. 
To work with it, we will need to download the relevant files first, and then 
query it.

```
# get all the URLs in this release
pbp_urls <- pb_download_url(repo = "nflverse/nflverse-data", tag = "player_stats")
# keep only the ones matching the desired regex pattern, "player_stats_####.parquet"
pbp_urls <- pbp_urls[grepl("player_stats_\\d+.csv", pbp_urls)]
arrow::open_dataset(pbp_urls, partitioning = NULL)
```
-->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
